name: CI/CD Pipeline - Multi-Environment Validation

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main

jobs:
  # ========================================
  # Validate Documentation & Lint
  # ========================================
  validate-docs:
    name: Validate Copilot Instructions & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Copilot Instructions
        run: |
          echo "üîç Validating .github/copilot-instructions.md structure..."

          if [ ! -f .github/copilot-instructions.md ]; then
            echo "‚ùå copilot-instructions.md not found"
            exit 1
          fi

          # Check for required sections
          required_sections=("Project Overview" "Tech Stack" "Development Guidelines")

          for section in "${required_sections[@]}"; do
            if ! grep -q "$section" .github/copilot-instructions.md; then
              echo "‚ùå Missing required section: $section"
              exit 1
            fi
          done

          echo "‚úÖ Copilot instructions validated successfully"

      - name: Run ESLint
        run: npm run lint

      - name: TypeScript Type Check
        run: npm run check

  # ========================================
  # Multi-Database Test Matrix
  # ========================================
  test-matrix:
    name: Test Suite (${{ matrix.db }})
    runs-on: ubuntu-latest
    needs: [validate-docs]

    strategy:
      matrix:
        db: [sqlite, postgres]
        include:
          - db: postgres
            DATABASE_URL: postgresql://aiuser:aipass@localhost:5432/aitradepro

    services:
      postgres:
        image: ${{ matrix.db == 'postgres' && 'postgres:15' || '' }}
        env:
          POSTGRES_USER: aiuser
          POSTGRES_PASSWORD: aipass
          POSTGRES_DB: aitradepro
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U aiuser -d aitradepro"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Database (${{ matrix.db }})
        env:
          DATABASE_URL: ${{ matrix.db == 'postgres' && 'postgresql://aiuser:aipass@localhost:5432/aitradepro' || 'sqlite:./test.db' }}
        run: |
          echo "üóÑÔ∏è  Setting up ${{ matrix.db }} database..."
          npm run db:push

      - name: Run Tests with Coverage
        env:
          DATABASE_URL: ${{ matrix.db == 'postgres' && 'postgresql://aiuser:aipass@localhost:5432/aitradepro' || 'sqlite:./test.db' }}
        run: npm run test:coverage

      - name: Upload Coverage Report
        if: matrix.db == 'postgres'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ========================================
  # Docker Build & Lint
  # ========================================
  docker-build:
    name: Docker Build & Validation
    runs-on: ubuntu-latest
    needs: [validate-docs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Dockerfile with hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./Dockerfile
          failure-threshold: error

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: aitradepro:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/aitradepro-ci.tar

      - name: Upload Docker artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/aitradepro-ci.tar
          retention-days: 1

  # ========================================
  # Security Audits
  # ========================================
  security-audit:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: [docker-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm run audit

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/aitradepro-ci.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: aitradepro:ci
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy security scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: aitradepro:ci
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ========================================
  # Build Verification
  # ========================================
  build-verification:
    name: Production Build Verification
    runs-on: ubuntu-latest
    needs: [test-matrix, docker-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Verify build artifacts
        run: |
          echo "üîç Verifying build artifacts..."

          if [ ! -d "dist" ]; then
            echo "‚ùå Server build output not found"
            exit 1
          fi

          if [ ! -d "dist/public" ]; then
            echo "‚ùå Client build output not found"
            exit 1
          fi

          echo "‚úÖ All build artifacts verified successfully"

  # ========================================
  # Summary
  # ========================================
  ci-complete:
    name: CI Pipeline Complete
    runs-on: ubuntu-latest
    needs: [validate-docs, test-matrix, docker-build, security-audit, build-verification]
    if: always()

    steps:
      - name: Check CI Status
        run: |
          echo "üéâ CI/CD Pipeline Complete!"
          echo "================================"
          echo "‚úÖ Documentation validated"
          echo "‚úÖ Multi-database tests passed"
          echo "‚úÖ Docker image built & scanned"
          echo "‚úÖ Security audits completed"
          echo "‚úÖ Production build verified"
          echo "================================"
